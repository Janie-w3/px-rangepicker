<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-time-rangepicker.html"/>
<link rel="import" href="px-date-rangepicker.html"/>
<link rel="import" href="px-rangepicker-presets.html"/>

<script src="../moment/moment.js"></script>

<!--
Rangepicker modal.

##### Usage

    <px-rangepicker-modal from={{...}} to={{...}}>
    </px-rangepicker-modal>
-->
<dom-module id="px-rangepicker-modal">
  <link rel="import" type="css" href="css/px-rangepicker.css"/>
  <template>
    <div class=overlay></div>
    <div id="rangepickerModal" class="rangepicker__box">
      <div class=flex>
        <div>
          <px-date-rangepicker
            id="dateRangePicker"
            class=u-p+
            first-range-date="{{firstRangeDate}}"
            second-range-date="{{secondRangeDate}}"
            allow-future-dates="{{allowFutureDates}}">
          </px-date-rangepicker>
          <px-time-rangepicker
            class="border--top u-p+"
            id="timeRangePicker"
            from-time="{{fromTime}}"
            to-time="{{toTime}}">
          </px-time-rangepicker>
        </div>
        <template is="dom-if" if="{{presetRanges}}">
          <px-rangepicker-presets id="presets" class="border--left u-p+" preset-ranges="{{presetRanges}}">
          </px-rangepicker-presets>
        </template>
      </div>
      <div class="flex flex--right border--top u-p-">
        <button class=btn on-click="_close">Close</button>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-rangepicker-modal',

    properties: {

      /**
       * Moment object start date & time for range picker
       */
      from: {
        type: Object,
        notify: true,
        observer: '_updatePickersFrom'
      },

      /**
       * Moment object end date & time for range picker
       */
      to: {
        type: Object,
        notify: true,
        observer: '_updatePickersTo'
      },

      /**
       * (optional) Set this attribute when you do want to allow future dates in the date range picker.
       *
       * If not set, then future dates will be disabled and unclickable.
       */
      allowFutureDates: {
        type: Boolean,
        value: false
      },

      /**
       * (optional) The preset date/time ranges to be displayed.  Defaults to none.
       *
       *```
       *   [
       *    {
       *      "displayText": "Last 5 Minutes",
       *      "startDateTime": "08/21/2015 12:57:33 PM",
       *      "endDateTime": "08/21/2015 1:02:33 PM"
       *    },
       *    {
       *      "displayText": "Last 12 Hours",
       *      "startDateTime": "08/21/2015 1:02:33 AM",
       *      "endDateTime": "08/21/2015 1:02:33 PM"
       *    }
       *   ]
       * ```
       */
      presetRanges: Object

    },

    _updatePickersFrom: function() {
      // ALWAYS take what comes in (from range fields, initialization)
      this.set('fromTime', moment(this.from));

      // EXCEPT when only 1 field is set, then ignore it
      if(this.secondRangeDate !== null) {
        this.set('firstRangeDate', moment(this.from));
      }
    },

    _updatePickersTo: function() {
      // ALWAYS take what comes in (from range fields, initialization)
      this.set('toTime', moment(this.to));

      // EXCEPT when only 1 field is set, then ignore it
      if(this.secondRangeDate !== null) {
        this.set('secondRangeDate', moment(this.to));
      }
    },

    observers: [
      '_broadcastToTimeChange(toTime)',
      '_broadcastFromTimeChange(fromTime)',
      '_broadcastDateRangeChange(firstRangeDate, secondRangeDate)'
    ],

    _broadcastToTimeChange: function() {
      var newTo = moment(this.to); // don't change the date
      newTo.hour(this.toTime.hour()); // update just the time
      newTo.minute(this.toTime.minute());
      newTo.second(this.toTime.second());

      if(!this.to.isSame(newTo, 'second')) {
        this.set('to', newTo); // only update if different
      }
    },

    _broadcastFromTimeChange: function() {
      var newFrom = moment(this.from); // don't change the date
      newFrom.hour(this.fromTime.hour()); // update just the time
      newFrom.minute(this.fromTime.minute());
      newFrom.second(this.fromTime.second());

      if(!this.from.isSame(newFrom, 'second')) {
        this.set('from', newFrom); // only update if different
      }
    },

    _broadcastDateRangeChange: function() {

      // only when a RANGE is selected (2 fields in the picker) do we broadcast the range
      if(this.secondRangeDate !== null) {

        var newTo = moment(this.to); // don't change the time
        var newFrom = moment(this.from);

        var fromDate = this.firstRangeDate;
        var toDate = this.secondRangeDate;
        if(this.firstRangeDate.isAfter(this.secondRangeDate, 'day')) {
          fromDate = this.secondRangeDate;
          toDate = this.firstRangeDate;
        }

        newTo.date(toDate.date()); // update just the date
        newTo.month(toDate.month());
        newTo.year(toDate.year());
        newFrom.date(fromDate.date());
        newFrom.month(fromDate.month());
        newFrom.year(fromDate.year());

        if(!this.to.isSame(newTo, 'day')) {
          this.set('to', newTo); // only update if different
        }
        if(!this.from.isSame(newFrom, 'day')) {
          this.set('from', newFrom); // only update if different
        }

      }

    },

    ready: function() {
      var self = this;

      this.$.rangepickerModal.addEventListener('px-preset-selected', function(e) {
        var presetStartDateTime = e.detail.startDateTime;
        var presetEndDateTime = e.detail.endDateTime;

        self.set('secondRangeDate', null); // first, deselect the second range date so no consequences
          // of first/second date picked

        self.set('firstRangeDate', moment(presetStartDateTime, 'MM/DD/YYYY hh:mm:ss A'));
        self.set('fromTime', moment(presetStartDateTime, 'MM/DD/YYYY hh:mm:ss A'));

        self.set('secondRangeDate', moment(presetEndDateTime, 'MM/DD/YYYY hh:mm:ss A'));
        self.set('toTime', moment(presetEndDateTime, 'MM/DD/YYYY hh:mm:ss A'));
      });

    },

    _close: function() {
      this.$.dateRangePicker._resetVisibleCalendars();
      this.fire('px-range-picking-done');
    }

  });
</script>
