<link rel="import" href="../polymer/polymer.html"/>

<script src="../moment/moment.js"></script>

<!--
Element that renders a calendar for the given year and selects the given date.

##### Usage

    <px-calendar display-month-year="{{displayMonthYear}}"
                 last-clicked-date="{{selectedDate}}">
    </px-calendar>

-->
<dom-module id="px-calendar">
  <link rel="import" type="css" href="css/px-calendar.css"/>
  <template>
    <table class="table table--no-cells text--center">
      <caption>
        <span>{{displayMonthName}}</span>
        <span>{{displayYear}}</span>
      </caption>
      <thead>
        <tr>
          <template is="dom-repeat" items="{{daysOfTheWeek}}" as="dayOfTheWeek">
            <th class="caps u-pt0">{{dayOfTheWeek}}</th>
          </template>
        </tr>
      </thead>
      <tbody>
        <template is="dom-repeat" items="{{calendar}}" as="week">
          <tr>
            <template is="dom-repeat" items="{{week}}" as="day">
              <td class$="{{day.tdStyles}}">
                <div>
                  <button class$="{{day.styles}}" value="{{day.value}}" on-click="_selectDate" disabled="{{day.isDisabled}}">{{day.value}}</button>
                </div>
              </td>
            </template>
          </tr>
        </template>
        <template is="dom-repeat" items="{{weeksToAdd}}">
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          </tr>
        </template>
      </tbody>
    </table>

  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-calendar',

    properties: {

      /**
       * The month and year to display
       *
       * Format 'MM/YYYY', for example: '02/2015' is Feb 2015
       */
      displayMonthYear: {
        type: String,
        observer: '_renderMonth'
      },


      firstDate: {
        type: String,
        observer: '_updateSelectionStyles',
        notify: true
      },

      secondDate: {
        type: String,
        observer: '_updateSelectionStyles',
        notify: true
      }

    },

    ready: function() {
      this.daysOfTheWeek = this._getDaysOfTheWeek();
    },

    _getDaysOfTheWeek: function() {
      var day = moment().startOf('week');
      var daysOfWeek = [];
      for (var i = 0; i < 7; i++) {
        daysOfWeek.push(day.format('dd'));
        day.add(1, 'days');
      }
      return daysOfWeek;
    },

    _isASelectedDate: function(date) {


      var selectedTo = moment(this.firstDate, 'MM/DD/YYYY').format('MM/YYYY');
      if (selectedTo === this.displayMonthYear) { // in this month
        var selectedDateDay = moment(this.firstDate, 'MM/DD/YYYY').format('D');
        if (selectedDateDay == date) {
          return true;
        }
      }

      var selectedFrom = moment(this.secondDate, 'MM/DD/YYYY').format('MM/YYYY');
      if (selectedFrom === this.displayMonthYear) { // in this month
        var selectedDateDay = moment(this.secondDate, 'MM/DD/YYYY').format('D');
        if (selectedDateDay == date) {
          return true;
        }
      }


      return false;
    },

    _isBetweenSelectedDates: function(date) {
      if(date !== '') {
        var firstDate = moment(this.firstDate, 'MM/DD/YYYY');
        var secondDate = moment(this.secondDate, 'MM/DD/YYYY');
        if (
          (moment(this.displayMonthYear, 'MM/YYYY').date(date).isBetween(firstDate, secondDate, 'day')) || (moment(this.displayMonthYear, 'MM/YYYY').date(date).isBetween(secondDate, firstDate, 'day'))
        ) {
          return true;
        }
      }
      return false;
    },

    _isPastTodaysDate: function(date) {
      var todaysDay = moment();
      var currentlyComparingDate = moment(this.displayMonthYear, 'MM/YYYY').date(date);
      if (currentlyComparingDate.isAfter(todaysDay)) {
        return true;
      }
      return false;
    },

    _isSoloDate: function(date) {
      if(date !== '') {
        var firstDate = moment(this.firstDate, 'MM/DD/YYYY');
        var secondDate = moment(this.secondDate, 'MM/DD/YYYY');


        var firstAndSecondDatesSame = firstDate.isSame(secondDate, 'day');
        var onlyHaveFirstDate = this.secondDate === null;

        var shouldApplyToThisDate = (moment(this.displayMonthYear, 'MM/YYYY').date(date).isSame(firstDate, 'day'));

        if(firstAndSecondDatesSame && shouldApplyToThisDate) {
          return true;
        }

        if(onlyHaveFirstDate && shouldApplyToThisDate) {
          return true;
        }
      }
      return false;
    },

    _updateSelectionStyles: function() {

      if (!this.calendar) {
        return;
      }

      var self = this;
      this.calendar.forEach(function(week, i) {
        week.forEach(function(dateObj, j) {

          var isDisabled = false, tdStyles = '';

          var styles = 'btn btn--bare';
          if (dateObj.value == "1") {
            tdStyles += ' is-first';
          }
          if (dateObj.value == moment(self.displayMonthYear, 'MM/YYYY').daysInMonth()) {
            tdStyles += ' is-last';
          }
          if (self._isASelectedDate(dateObj.value)) {
            tdStyles += ' is-selected';
          }
          if (self._isBetweenSelectedDates(dateObj.value)) {
            tdStyles += ' is-between';
          }
          if (self._isSoloDate(dateObj.value)) {
            tdStyles += ' is-selected-solo';
          }
          if (self._isPastTodaysDate(dateObj.value)) {
            styles += ' btn--disabled';
            isDisabled = true;
          }

          if (dateObj.styles !== styles || dateObj.isDisabled !== isDisabled  || dateObj.tdStyles !== tdStyles) {
            self.set('calendar.' + i + '.' + j, {value: dateObj.value, styles: styles, isDisabled: isDisabled, tdStyles: tdStyles});
          }

        });
      });
    },

    _constructMonth: function(monthToDisplay) {

      var numberOfDaysInMonth = monthToDisplay.daysInMonth();
      var dayBeginningOfMonth = monthToDisplay.startOf('month').day();

      var dateCount = 1; // 1-31 or 30 or 28
      var daysNotInMonthCount = 0;
      var month = [];

      while (dateCount <= numberOfDaysInMonth) {

        var week = [];
        var weekCount = 0;  // 0 - 6 (days of week)

        // days not in the month
        while (daysNotInMonthCount < dayBeginningOfMonth) {
          week.push({value: '', styles: 'btn btn--bare', isDisabled: false, tdStyles: ''});
          daysNotInMonthCount++;
          weekCount++;
        }

        while (weekCount < 7) {
          if (dateCount <= numberOfDaysInMonth) {
            week.push({value: dateCount, styles: 'btn btn--bare', isDisabled: false, tdStyles: ''});
          }
          else {
            week.push({value: '', styles: 'btn btn--bare', isDisabled: false, tdStyles: ''});
          }
          dateCount++;
          weekCount++;
        }

        month.push(week);

      }

      return month;

    },

    _renderMonth: function() {
      var monthToDisplay = moment(this.displayMonthYear, 'M/YYYY');

      this.displayMonthName = monthToDisplay.format('MMMM');
      this.displayYear = monthToDisplay.format('YYYY');

      this.set('calendar', this._constructMonth(monthToDisplay));

      var numberOfWeeksToAdd = 6 - this.calendar.length;
      var weeksToAdd = [];
      for (var i = 0; i < numberOfWeeksToAdd; i++) {
        weeksToAdd.push(i)
      }
      this.set('weeksToAdd', weeksToAdd);

      this._updateSelectionStyles();
    },

    _selectDate: function(e) {

      var newSelectedDate = moment(this.displayMonthYear, 'MM/YYYY');
      newSelectedDate.date(e.target.value);

      if(this.firstDate && !this.secondDate) {
        this.set('secondDate', newSelectedDate.format('MM/DD/YYYY'));
        this.fire('range-selected');
      }
      else {
        this.set('firstDate', newSelectedDate.format('MM/DD/YYYY'));
        this.set('secondDate', null);
      }

    }

  });
</script>
