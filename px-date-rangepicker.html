<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-calendar.html"/>

<script src="../moment/moment.js"></script>

<!--
Datepicker element which allows user to select a date.

##### Usage

    <px-datepicker selected-date="{{datePickerDate}}"></px-datepicker>

-->
<dom-module id="px-date-rangepicker">
  <link rel="import" type="css" href="css/px-date-rangepicker.css"/>
  <template>
    <div class=overlay></div>
    <div id="box" class="rangepicker__box u-pb-">
      <div class="flex flex--top border--bottom u-ph+">
        <div class="flex flex--top u-mr+ u-pt+">
          <button on-click="_jumpBack" class="btn btn--bare u--mr-">
            <i class="fa fa-angle-left"></i>
          </button>
          <px-calendar id="leftCalendar"
                       display-month-year="{{leftDisplayMonthYear}}"
                       first-date="{{firstDate}}"
                       second-date="{{secondDate}}">
          </px-calendar>
        </div>
        <div class="flex flex--top u-ml+ border--right u-pt+ u-pr+">
          <px-calendar id="rightCalendar"
                       display-month-year="{{rightDisplayMonthYear}}"
                       first-date="{{firstDate}}"
                       second-date="{{secondDate}}">
          </px-calendar>
          <button id=btnNextMonth on-click="_jumpForward" class="btn btn--bare u--ml-">
            <i class="fa fa-angle-right"></i>
          </button>
        </div>
        <div class="u-pt+ u-pl+">
          <h4 class="caps u-mt0 u-mb-">Date Range</h4>
          <ul class=list-bare>
            <li class=u-mb->
              <button class="btn btn--bare">Today</button>
            </li>
            <li class=u-mb->
              <button class="btn btn--bare">Yesterday</button>
            </li>
            <li class=u-mb->
              <button class="btn btn--bare">Last 7 days</button>
            </li>
            <li class=u-mb->
              <button class="btn btn--bare">Last 30 days</button>
            </li>
            <li class=u-mb->
              <button class="btn btn--bare">This Month</button>
            </li>
            <li>
              <button class="btn btn--bare">Last Month</button>
            </li>
          </ul>
        </div>
      </div>
      <div class="flex flex--right u-pt- u-pr-">
        <input class="btn btn--primary" type=submit value=Apply on-click="_applyDate">
        <button class=btn on-click="_cancel">Cancel</button>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-date-rangepicker',

    properties: {

      fromDate: {
        type: String,
        notify: true
      },

      toDate: {
        type: String,
        notify: true
      }

    },
    
    _updateFromDate: function() {
      this.set('leftDisplayMonthYear', this._addMonth('fromDate', 0));
      this.set('rightDisplayMonthYear', this._addMonth('fromDate', 1));
    },
    
    _addMonth: function(monthYear, numberToAdd) {
      return moment(this[monthYear], 'MM/DD/YYYY').add(numberToAdd, 'months').format('MM/YYYY');
    },

    observers: [
      'updateSelectedRange(fromDate, toDate)'
    ],

    ready: function() {
      var self = this;
      this.$.box.addEventListener('range-selected', function() {

        var fromDate = self.firstDate;
        var toDate = self.secondDate;

        if (moment(self.firstDate, 'MM/DD/YYYY').isAfter(moment(self.secondDate, 'MM/DD/YYYY'))) {
          toDate = self.firstDate;
          fromDate = self.secondDate;
        }

        self.set('fromDate', fromDate);
        self.set('toDate', toDate);

      });
    },

    updateSelectedRange: function() {

      // if no display months set (nothing on the calendars), initialize them to the fromDate & fromDate + 1
      if (!this.leftDisplayMonthYear && !this.rightDisplayMonthYear) {
        this._resetInputFields();
      }

      this._checkCurrentMonth();

    },

    _checkCurrentMonth: function() {
      if (this._isCurrentMonth()) {
        this.toggleAttribute('disabled', true, this.$.btnNextMonth);
        this.toggleClass('btn--disabled', true, this.$.btnNextMonth);
      }
      else {
        this.toggleAttribute('disabled', false, this.$.btnNextMonth);
        this.toggleClass('btn--disabled', false, this.$.btnNextMonth);
      }
    },

    _isCurrentMonth: function() {
      var now = moment();
      if (moment(this.rightDisplayMonthYear, 'MM/YYYY').isSame(now, 'month')) {
        return true;
      }
      return false;
    },

    _resetInputFields: function() {

      this.set('leftDisplayMonthYear', moment(this.fromDate, 'MM/DD/YYYY').add(0, 'months').format('MM/YYYY'));//this._addMonth('fromDate', 0));
      this.set('rightDisplayMonthYear', moment(this.fromDate, 'MM/DD/YYYY').add(1, 'months').format('MM/YYYY'));//this._addMonth('fromDate', 1));

      this.set('firstDate', this.fromDate);
      this.set('secondDate', this.toDate);
    },

    _jumpBack: function() {
      this.set('leftDisplayMonthYear', this._addMonth('leftDisplayMonthYear', -1));
      this.set('rightDisplayMonthYear', this._addMonth('rightDisplayMonthYear', -1));
      this._checkCurrentMonth();
    },

    _jumpForward: function() {
      this.set('leftDisplayMonthYear', this._addMonth('leftDisplayMonthYear', 1));
      this.set('rightDisplayMonthYear', this._addMonth('rightDisplayMonthYear', 1));
      this._checkCurrentMonth();
    },

    _applyDate: function() {
      this.fire('px-date-picking-done');
    },

    _cancel: function() {
      //this._resetInputFields(); // reset the input to the previously chosen date
      
      this.set('firstDate', this.backupFirstDate);
      this.set('secondDate', this.backupSecondDate);

      this.fire('px-date-picking-done');
    },
    
    _saveBackup: function() {
      this.backupFirstDate = this.firstDate;
      this.backupSecondDate = this.secondDate;
    },
    
    hide: function() {
      this.toggleAttribute('hidden', true);
    },
        
    show: function() {
      this.toggleAttribute('hidden', false);
    }


  });
</script>
