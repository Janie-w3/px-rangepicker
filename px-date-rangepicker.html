<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-calendar.html"/>

<script src="../moment/moment.js"></script>

<!--
Datepicker element which allows user to select a date.

##### Usage

    <px-date-rangepicker from-date="{{...}}" to-date="{{...}}"></px-date-rangepicker>

-->
<dom-module id="px-date-rangepicker">
  <link rel="import" type="css" href="css/px-date-rangepicker.css"/>
  <template>
    <div id=box class="flex flex--top border--bottom u-ph+">
      <div class="flex flex--top u-mr+ u-pt+">
        <button on-click="_jumpBack" class="btn btn--bare u--mr-">
          <i class="fa fa-angle-left"></i>
        </button>
        <px-calendar
          id="leftCalendar"
          display-month-year="{{leftDisplayMonthYear}}"
          first-range-date="{{firstRangeDate}}"
          second-range-date="{{secondRangeDate}}">
        </px-calendar>
      </div>
      <div class="flex flex--top u-ml+ border--right u-pt+ u-pr+">
        <px-calendar
          id="rightCalendar"
          display-month-year="{{rightDisplayMonthYear}}"
          first-range-date="{{firstRangeDate}}"
          second-range-date="{{secondRangeDate}}">
        </px-calendar>
        <button id=btnNextMonth on-click="_jumpForward" class="btn btn--bare u--ml-">
          <i class="fa fa-angle-right"></i>
        </button>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-date-rangepicker',

    properties: {

      /**
       * Moment object with range start date
       */
      fromDate: {
        type: Object,
        notify: true
      },

      /**
       * Moment object with range end date
       */
      toDate: {
        type: Object,
        notify: true
      }

    },

    observers: [
      'updateSelectedRange(fromDate, toDate)'
    ],

    updateSelectedRange: function() {

      // if nothing is displayed on the calendars yet, reset the state
      if (!this.leftDisplayMonthYear && !this.rightDisplayMonthYear) {
        this._resetState();
      }
      // otherwise, leave them as is (don't bother reassigning first/second dates for performance reasons)

      this._checkCurrentMonth();

    },

    _resetState: function() {
      // initialize the displayed months to the selected fromDate & fromDate + 1
      this.set('leftDisplayMonthYear', moment(this.fromDate).startOf('month'));
      this.set('rightDisplayMonthYear', moment(this.fromDate).startOf('month').add(1, 'months'));

      // initialize the first and second selected dates to the to and from dates
      this.set('firstRangeDate', moment(this.fromDate));
      this.set('secondRangeDate', moment(this.toDate));
    },

    ready: function() {
      var self = this;
      this.$.box.addEventListener('range-selected', function() {

        var fromDate = self.firstRangeDate;
        var toDate = self.secondRangeDate;

        if (self.firstRangeDate.isAfter(self.secondRangeDate)) {
          toDate = self.firstRangeDate;
          fromDate = self.secondRangeDate;
        }

        self.set('fromDate', fromDate);
        self.set('toDate', toDate);

      });
    },

    _checkCurrentMonth: function() {
      if (this._isCurrentMonth()) {
        this.toggleAttribute('disabled', true, this.$.btnNextMonth);
        this.toggleClass('btn--disabled', true, this.$.btnNextMonth);
      }
      else {
        this.toggleAttribute('disabled', false, this.$.btnNextMonth);
        this.toggleClass('btn--disabled', false, this.$.btnNextMonth);
      }
    },

    _isCurrentMonth: function() {
      var now = moment();
      return this.rightDisplayMonthYear.isSame(now, 'month');
    },

    _jumpBack: function() {
      this.set('leftDisplayMonthYear', moment(this.leftDisplayMonthYear.add(-1, 'months')));
      this.set('rightDisplayMonthYear', moment(this.rightDisplayMonthYear.add(-1, 'months')));
      this._checkCurrentMonth();
    },

    _jumpForward: function() {
      this.set('leftDisplayMonthYear', moment(this.leftDisplayMonthYear.add(1, 'months')));
      this.set('rightDisplayMonthYear', moment(this.rightDisplayMonthYear.add(1, 'months')));
      this._checkCurrentMonth();
    }

  });
</script>
