<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-range-fields.html"/>
<link rel="import" href="px-time-rangepicker.html"/>
<link rel="import" href="px-date-rangepicker.html"/>

<script src="../moment/moment.js"></script>

<!--
Rangepicker with time element.

##### Usage

    <px-rangepicker from-time={{...}} to-time={{...}}
                    from-date={{...}} to-date={{...}}>
    </px-rangepicker>
-->
<dom-module id="px-rangepicker">
  <link rel="import" type="css" href="css/px-rangepicker.css"/>
  <template>
    <px-range-fields id="rangeFields"
                     from-time="{{fromTimeMoment}}"
                     to-time="{{toTimeMoment}}"
                     from-date="{{fromDateMoment}}"
                     to-date="{{toDateMoment}}">
    </px-range-fields>
    <px-time-rangepicker
      id="timeRangePicker"
      from-time="{{fromTimeMoment}}"
      to-time="{{toTimeMoment}}"
      hidden>
    </px-time-rangepicker>
    <px-date-rangepicker
      id="dateRangePicker"
      from-date="{{fromDateMoment}}"
      to-date="{{toDateMoment}}"
      allow-future-dates="{{allowFutureDates}}"
      hidden>
    </px-date-rangepicker>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-rangepicker',

    properties: {

      /**
       * Start time for time picker
       *
       * Format 'hh:mm:ss A', for example: '10:22:00 AM'
       */
      fromTime: {
        type: String,
        notify: true,
        observer: '_updateFromTime'
      },

      /**
       * End time for time picker
       *
       * Format 'hh:mm:ss A', for example: '04:55:00 PM'
       */
      toTime: {
        type: String,
        notify: true,
        observer: '_updateToTime'
      },

      /**
       * Start date for date picker
       *
       * Format 'MM/DD/YYYY', for example: '01/25/2015' is Jan 25 2015
       */
      fromDate: {
        type: String,
        notify: true,
        observer: '_updateFromDate'
      },

      /**
       * End date for date picker
       *
       * Format 'MM/DD/YYYY', for example: '11/03/2015' is Nov 3 2015
       */
      toDate: {
        type: String,
        notify: true,
        observer: '_updateToDate'
      },

      /**
       * Set this attribute when you do want to allow future dates in the date range picker.
       *
       * If not set, then future dates will be disabled and unclickable.
       */
      allowFutureDates: {
        type: Boolean,
        value: false
      }

    },

    observers: [
      '_updateInputs(fromDateMoment, toDateMoment, fromTimeMoment, toTimeMoment)'
    ],

    _updateInputs: function() {
      this.set('fromDate', this.fromDateMoment.format('MM/DD/YYYY'));
      this.set('toDate', this.toDateMoment.format('MM/DD/YYYY'));
      this.set('fromTime', this.fromTimeMoment.format('hh:mm:ss A'));
      this.set('toTime', this.toTimeMoment.format('hh:mm:ss A'));
    },

    _updateFromDate: function() {
      this.set('fromDateMoment', moment(this.fromDate, 'MM/DD/YYYY'));
    },

    _updateToDate: function() {
      this.set('toDateMoment', moment(this.toDate, 'MM/DD/YYYY'));
    },

    _updateFromTime: function() {
      this.set('fromTimeMoment', moment(this.fromTime, 'hh:mm:ss A'));
    },

    _updateToTime: function() {
      this.set('toTimeMoment', moment(this.toTime, 'hh:mm:ss A'));
    },

    ready: function() {

      var self = this;

      this.$.timeRangePicker.addEventListener('px-time-picking-done', function(e) {
        self.$.timeRangePicker.toggleAttribute('hidden', true);
      });

      this.$.dateRangePicker.addEventListener('px-date-picking-done', function(e) {
        self.$.dateRangePicker.hide();
      });

      this.$.rangeFields.addEventListener('px-selected-range-field', function(e) {
        var dateOrTime = e.detail.dateOrTime;
        var toOrFrom = e.detail.toOrFrom;

        self.$.dateRangePicker.show();
        self.$.timeRangePicker.toggleAttribute('hidden', false);

        if (dateOrTime === 'time') {
          self.$.timeRangePicker.focusField = toOrFrom;
        }

      });
    }

  });
</script>
